<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>

    <!-- Script -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- icon fontawesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <!-- Boostrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- carousel -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css">
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.theme.default.min.css">

    <!-- link CSS -->
    <link rel="stylesheet" href="/assets/css/style.css">




</head>

<body class="font-sans">
    <div class="header-sticky">
        <!-- Top Navigation -->
        <div th:insert="~{/web/fragments/header}"></div>
        <!-- Breadcrumb -->
        <div class="bg-green-500 text-white py-2 px-4 ">
            <div class="container mx-auto ">
                <span>Trang ch·ªß > S·∫£n ph·∫©m</span>
            </div>
        </div>
    </div>

    <!-- div separate -->

    <div class="container mx-auto p-4">

        <h1 class="text-lg font-bold text-red-500" style="font-size: 30px;">
            <i class="fas fa-map-marker-alt">
            </i>
            ƒê·ªãa ch·ªâ nh·∫≠n h√†ng
        </h1>
        <div th:each="address : ${addresses}">
            <div class="flex items-start justify-between mt-2" th:if="${address.isDefault==true}"   th:attr="data-address-id=${address.id}">
                <div class="ml-2 max-w-[70%] break-words addSelected">
                    <span class="text-sm font-bold" id="fullName" th:text="${address.fullName}">Trung D≈©ng</span>
                    <span class="font-bold">(+84)</span>
                    <span class="font-bold" id="phone" th:text="${address.phone}">342709006</span>
                    <p class="text-sm overflow-hidden break-words" id="addressDetail" th:text="${address.addressDetail}">
                        ƒê∆∞·ªùng ƒê·∫Øp M·ªπ T·∫°p H√≥a C√¥ Hoa ƒê·ªëi Di·ªán C√≥ ƒê∆∞·ªùng B√™ T√¥ng Ch·∫°y H·∫øt ƒê∆∞·ªùng B√™ T√¥ng Qu·∫πo Tr√°i Nh√† N·∫±m B√™n
                        Ph·∫£i, Th·ªã Tr·∫•n An Ph√∫, Huy·ªán An Ph√∫, An Giang
                    </p>
                    <span th:text="${address.addressSelected}" id="addressSelect">Th·ªã Tr·∫•n An Ph√∫, Huy·ªán An Ph√∫, An Giang </span>

                </div>
                <div class="ml-auto flex items-center whitespace-nowrap flex-shrink-0" >
                    <button class="text-red-500 text-sm mr-2">M·∫∑c ƒë·ªãnh</button>
                    <button id="change-address-btn" class="border border-gray-300 px-2 py-1 text-sm">
                        Thay ƒë·ªïi
                    </button>
                </div>
            </div>





        </div>
        <!-- Hi·ªÉn th·ªã khi kh√¥ng c√≥ ƒë·ªãa ch·ªâ -->
        <div th:if="${#lists.isEmpty(addresses) || addresses.?[isDefault == true].size() == 0}"
             class="flex items-center mt-2">
            <div class="ml-2">
                <p class="text-sm">
                    B·∫°n ch∆∞a c√≥ ƒë·ªãa ch·ªâ nh·∫≠n h√†ng
                </p>
            </div>
            <div class="ml-auto flex items-center">
                <button id="add-new-address-btn" class="border border-gray-300 px-2 py-1 text-sm">
                    Th√™m ƒë·ªãa ch·ªâ
                </button>
            </div>
        </div>
        <hr class="my-4" />




        <!-- Modal (·∫©n ban ƒë·∫ßu) -->
        <div id="address-modal" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden" style="z-index: 111">
            <div class="bg-white p-6 rounded-lg shadow-lg w-1/2">
                <h1 class="text-xl font-semibold mb-4">ƒê·ªãa Ch·ªâ C·ªßa T√¥i</h1>

                <div class="border border-gray-300 p-4 rounded-lg">
                    <ul>
                        <li th:each="address : ${addresses}" class="flex items-start mb-4 p-2 border-b">
                            <!-- Radio ch·ªçn ƒë·ªãa ch·ªâ -->
                            <input type="radio" name="selectedAddress" th:value="${address.id}" th:checked="${address.isDefault}" class="mt-1 cursor-pointer" />

                            <!-- N·ªôi dung ƒë·ªãa ch·ªâ -->
                            <div class="flex-grow ml-2 cursor-pointer" onclick="this.previousElementSibling.checked = true;">
                                <div class="flex items-center mb-2">
                                    <span class="font-semibold text-lg" th:text="${address.fullName}">Trung D≈©ng</span>
                                    <span class="ml-2 text-gray-600">(+84) <span th:text="${address.phone}">342709006</span></span>
                                </div>
                                <p class="text-gray-700" th:text="${address.addressDetail}">
                                    ƒê∆∞·ªùng ƒê·∫Øp M·ªπ T·∫°p H√≥a C√¥ Hoa ƒê·ªëi Di·ªán C√≥ ƒê∆∞·ªùng B√™ T√¥ng...
                                </p>
                                <span th:text="${address.addressSelected}">Th·ªã Tr·∫•n An Ph√∫, Huy·ªán An Ph√∫, An Giang </span>
                                <span th:if="${address.isDefault}" class="text-red-500 mt-2 block">M·∫∑c ƒë·ªãnh</span>
                            </div>

                            <!-- N√∫t c·∫≠p nh·∫≠t -->
                            <button class="ml-4 text-blue-600 border border-blue-600 rounded px-2 py-1">C·∫≠p nh·∫≠t</button>
                        </li>
                    </ul>
                </div>

                <!-- N√∫t "Th√™m ƒê·ªãa Ch·ªâ M·ªõi" -->
                <button id="add-address-btn" class="flex items-center text-gray-700 border border-gray-400 rounded px-4 py-2 mt-4">
                    <i class="fas fa-plus mr-2"></i> Th√™m ƒê·ªãa Ch·ªâ M·ªõi
                </button>

                <!-- N√∫t ƒëi·ªÅu h∆∞·ªõng -->
                <div class="flex justify-end mt-4">
                    <button id="close-modal-btn" class="border border-gray-400 rounded px-4 py-2 mr-2">H·ª¶Y</button>
                    <button id="confirm-address-btn" class="bg-red-500 text-white rounded px-4 py-2">X√ÅC NH·∫¨N</button>
                </div>
            </div>
        </div>


        <!-- Modal new adƒëd -->
        <div id="new-address-modal"
             class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden" style="z-index: 111">
            <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-2xl">
                <h1 class="text-xl font-semibold mb-4">ƒê·ªãa Ch·ªâ M·ªõi</h1>
                <form>
                    <div class="grid grid-cols-1 gap-4 mb-4">
                        <div class="grid grid-cols-2 gap-4">
                            <input type="text" placeholder="H·ªç v√† t√™n" class="border border-gray-300 p-3 w-full">
                            <input type="text" placeholder="S·ªë ƒëi·ªán tho·∫°i" class="border border-gray-300 p-3 w-full">
                        </div>
                        <div class="grid grid-cols-3 gap-4">
                            <select class="border border-gray-300 p-3 w-full" id="province">
                                <option>T·ªânh/Th√†nh ph·ªë</option>
                            </select>
                            <select class="border border-gray-300 p-3 w-full" id="district">
                                <option>Qu·∫≠n/Huy·ªán</option>
                            </select>
                            <select class="border border-gray-300 p-3 w-full" id="ward">
                                <option>Ph∆∞·ªùng/X√£</option>
                            </select>
                        </div>
                        <div>
                            <textarea placeholder="ƒê·ªãa ch·ªâ c·ª• th·ªÉ"
                                      class="border border-gray-300 p-3 w-full h-24"></textarea>
                        </div>
                    </div>
                    <div class="flex items-center mb-4">
                        <input type="checkbox" id="defaultAddress" class="mr-2">
                        <label for="defaultAddress" class="text-sm">ƒê·∫∑t l√†m ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh</label>
                    </div>
                    <div class="flex justify-between">
                        <button type="button" id="back-modal-btn" class="border border-gray-300 px-4 py-2">Tr·ªü
                            l·∫°i</button>
                        <button type="submit" id="submit-new-address" class="bg-red-500 text-white px-4 py-2">HO√ÄN TH√ÄNH</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Th·ªùi gian giao h√†ng d·ª± ki·∫øn -->
        <div class="text-sm text-gray-600 mt-1">
           <span style="font-size: 20px"> D·ª± ki·∫øn giao h√†ng v√†o:</span>
            <span style="font-size: 20px" class="font-semibold text-black" id="estimated-delivery">---</span>
        </div>

    </div>


    <!-- payment -->
    <div class="container mx-auto pl-4 pr-4 pb-4">
        <h1 class="text-lg font-semibold mb-4">
            Ph∆∞∆°ng Th·ª©c Thanh To√°n
        </h1>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="space-y-4">
                <div class="border p-4 flex items-center cursor-pointer" onclick="document.getElementById('payment-cod').checked = true;">
                    <input id="payment-cod" class="mr-4" name="payment-method" type="radio" />
                    <img alt="COD icon" class="mr-4" height="30"
                         src="https://storage.googleapis.com/a1aa/image/15H1i4leLyIRg1dxyX1oI4FkMbTOBls4Z2UekJLhVfw.jpg"
                         width="30" />
                    <span>
                        Thanh to√°n khi nh·∫≠n h√†ng
                    </span>
                </div>
                <div class="border p-4 flex items-center cursor-pointer" onclick="document.getElementById('payment-bank').checked = true;">
                    <input id="payment-bank" class="mr-4" name="payment-method" type="radio" />
                    <img alt="Bank transfer icon" class="mr-4" height="30"
                         src="https://storage.googleapis.com/a1aa/image/pwbyKXtwWltL3GbEOsUvVoHFh22A4iPHMNFTBsaOeSk.jpg"
                         width="30" />
                    <span>
                        Chuy·ªÉn kho·∫£n qua ng√¢n h√†ng
                    </span>
                </div>
                <div class="border p-4 flex items-center cursor-pointer" onclick="document.getElementById('payment-vnp').checked = true;">
                    <input id="payment-vnp" class="mr-4" name="payment-method" type="radio" />
                    <img alt="VNPay icon" class="mr-4" height="30"
                         src="https://storage.googleapis.com/a1aa/image/BtEcjpagmT5QXeIjdUzk0KDbGXa1DrbeJEfeFlE_DdA.jpg"
                         width="30" />
                    <span>
                        Th·∫ª ATM/Visa/Master/JCB/QR Pay qua c·ªïng VNPAY
                    </span>
                </div>
                <div class="border p-4 flex items-center cursor-pointer" onclick="document.getElementById('payment-moca').checked = true;">
                    <input id="payment-moca" class="mr-4" name="payment-method" type="radio" />
                    <img alt="Moca Grab icon" class="mr-4" height="30"
                         src="https://storage.googleapis.com/a1aa/image/L6NXF17C2s1PPeCLYotsBScQZ6t6XCLIlm8GDimFCk0.jpg"
                         width="30" />
                    <span>
                        V√≠ Moca tr√™n ·ª©ng d·ª•ng Grab
                    </span>
                </div>
                <div class="border p-4 flex items-center cursor-pointer" onclick="document.getElementById('payment-momo').checked = true;">
                    <input id="payment-momo" class="mr-4" name="payment-method" type="radio" />
                    <img alt="Momo icon" class="mr-4" height="30"
                         src="https://storage.googleapis.com/a1aa/image/CalPDwoI3Cf4AoHvXZgemSdp9NduWvxIdvGitTqfEr8.jpg"
                         width="30" />
                    <span>
                        V√≠ Momo
                    </span>
                </div>
                <div class="border p-4 flex items-center cursor-pointer" onclick="document.getElementById('payment-shoppy').checked = true;">
                    <input id="payment-shoppy" class="mr-4" name="payment-method" type="radio" />
                    <img alt="ShopeePay icon" class="mr-4" height="30"
                         src="https://storage.googleapis.com/a1aa/image/iKUI_WY2hNqglZaC0heVpNOG4ZE3Oj2lUZv1ZjauMME.jpg"
                         width="30" />
                    <span>
                        V√≠ ShopeePay
                    </span>
                </div>
            </div>
            <div class="space-y-4 ">
                <div class="border p-4 formCart">
                    <div class="flex items-center mb-4 relative" th:each="cartItem : ${cartItems}">
                        <div class="relative">
                            <img th:alt="${cartItem.productVariant.product.name}" class="w-12 h-12 mr-4 border" height="50"
                                 th:src="${cartItem.productVariant.product.imageUrl}"
                                 width="50" />
                            <div class="absolute top-0 right-0 bg-gray-200 rounded-full w-6 h-6 flex items-center justify-center text-xs"
                                 style="margin-top: -12px;" th:text="${cartItem.quantity}">
                                2
                            </div>
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <span class="text-sm line-clamp-2" th:text="${cartItem.productVariant.product.name}" style="width: 75%">
                                    C·∫£i xoƒÉn kale
                                </span>
                                <span class="text-sm text-red-500" th:with="price=${cartItem.productVariant.product.discount != null ?
                      cartItem.productVariant.price - (cartItem.productVariant.price * cartItem.productVariant.product.discount / 100) :
                      cartItem.productVariant.price}"
                                      th:text="${#numbers.formatDecimal(price * cartItem.quantity, 0, 'COMMA', 0, 'POINT')} + '‚Ç´'">
                    63,000‚Ç´
                </span>
                            </div>
                            <span class="text-xs text-gray-500" th:text="${cartItem.productVariant.weight}">
                                ORGANICA / 300g
                            </span>
                        </div>
                    </div>

                </div>
                <div class="border p-4 flex items-center">
                    <input class="border p-2 flex-1 mr-4" placeholder="M√£ gi·∫£m gi√°" type="text" />
                    <button class="bg-green-500 text-white px-4 py-2">
                        S·ª≠ d·ª•ng
                    </button>
                </div>
                <div class="border p-4">
                    <div class="flex justify-between mb-2">
                        <span >
                            T·∫°m t√≠nh
                        </span>
                        <span class="text-red-500" id="provisional-costs" th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')} + '‚Ç´'">
                            ‚Äî
                        </span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span>
                            Ph√≠ v·∫≠n chuy·ªÉn
                        </span>
                        <span id="shipping-fee" class="text-red-500">
                            ‚Äî
                        </span>
                    </div>
                    <div class="flex justify-between font-semibold">
                        <span>
                            T·ªïng c·ªông:
                        </span>
                        <span class="text-red-500" id="total-price-payment">
                             ‚Äî
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex justify-between mt-4">
            <a class="text-blue-500" href="#">
                Quay tr·ªü l·∫°i gi·ªè h√†ng
            </a>
            <button class="bg-green-500 text-white px-6 py-2" id="btn-order-payment">
                ƒê·∫∂T H√ÄNG
            </button>
        </div>
    </div>

    <!-- QR Code Hi·ªÉn Th·ªã Khi Thanh To√°n -->
    <!-- Modal Thanh To√°n -->
    <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="paymentModalLabel">Th√¥ng Tin Thanh To√°n</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h3 class="text-success text-center">Qu√©t m√£ QR ƒë·ªÉ thanh to√°n</h3>
                    <div class="d-flex flex-column align-items-center mt-4 mb-4">
                        <img id="qr-code" src="" class="img-fluid mb-4" alt="QR Code">
                        <p class="mt-2 ">Ho·∫∑c chuy·ªÉn kho·∫£n theo th√¥ng tin b√™n d∆∞·ªõi:</p>
                    </div>

                    <table class="table">
                        <tbody>
                        <tr>
                            <td>Ch·ªß t√†i kho·∫£n:</td>
                            <td><b> L√™ Trung D≈©ng</b></td>
                        </tr>
                        <tr>
                            <td>Ng√¢n h√†ng:</td>
                            <td><b>BIDV</b></td>
                        </tr>
                        <tr>
                            <td>S·ªë t√†i kho·∫£n:</td>
                            <td><b>96247VYDE5</b></td>
                        </tr>
                        <tr>
                            <td>S·ªë ti·ªÅn:</td>
                            <td><b><span id="payment-amount"></span></b></td>
                        </tr>
                        <tr>
                            <td>N·ªôi dung CK:</td>
                            <td>Thanh toan cho don hang <b id="payment-content"></b></td>
                        </tr>
                        </tbody>
                    </table>

                    <div id="payment-status" class="text-center mt-3 text-muted">üîÑ ƒêang ch·ªù thanh to√°n...</div>

                    <p class="bg-light p-2 text-center">‚ö† L∆∞u √Ω: Vui l√≤ng gi·ªØ nguy√™n n·ªôi dung chuy·ªÉn kho·∫£n ƒë·ªÉ h·ªá th·ªëng t·ª± ƒë·ªông x√°c nh·∫≠n thanh to√°n!</p>
                </div>
            </div>
        </div>
    </div>


    <!-- Footer -->
<div class="bg-gray-900 text-white footer">
    <div th:insert="~{/web/fragments/footer}"></div>
</div>
<!-- Script boostrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

<!-- JS carousel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
<script src="/assets/js/main.js"></script>
<script th:inline="javascript">
        const  addresses  = [[${addresses}]];
        console.log('addresses', addresses);
        const  totalAmount = [[${totalAmount}]];
        console.log('totalAmount', totalAmount);
        const cartItems = [[${cartItems}]];
        console.log('cartItems', cartItems);
</script>
    <!-- JavaScript ƒë·ªÉ x·ª≠ l√Ω modal -->
<script>
    // Update the existing script section for handling the address modal
    document.addEventListener("DOMContentLoaded", function () {
        // Get reference to elements
        const changeAddressBtn = document.getElementById("change-address-btn");
        const addressModal = document.getElementById("address-modal");
        const closeModalBtn = document.getElementById("close-modal-btn");
        const confirmAddressBtn = document.getElementById("confirm-address-btn");
        const addNewAddressBtn = document.getElementById("add-new-address-btn");
        const addAddressBtn = document.getElementById("add-address-btn");
        const newAddressModal = document.getElementById("new-address-modal");
        const backModalBtn = document.getElementById("back-modal-btn");
        const submitNewAddress = document.getElementById("submit-new-address");

        // Open address modal
        if (changeAddressBtn) {
            changeAddressBtn.addEventListener("click", function () {
                addressModal.classList.remove("hidden");
            });
        }

        // Handle "Add address" button when no address exists
        if (addNewAddressBtn) {
            addNewAddressBtn.addEventListener("click", function () {
                newAddressModal.classList.remove("hidden");
            });
        }

        // Close address modal
        if (closeModalBtn) {
            closeModalBtn.addEventListener("click", function () {
                addressModal.classList.add("hidden");
            });
        }

        // Close modal when clicking outside
        addressModal.addEventListener("click", function (event) {
            if (event.target === this) {
                this.classList.add("hidden");
            }
        });

        // Open new address modal
        addAddressBtn.addEventListener("click", function () {
            newAddressModal.classList.remove("hidden");
        });

        // Back button in new address modal
        backModalBtn.addEventListener("click", function () {
            newAddressModal.classList.add("hidden");
        });

        // Close new address modal when clicking outside
        newAddressModal.addEventListener("click", function (event) {
            if (event.target === this) {
                this.classList.add("hidden");
            }
        });

        // Close new address modal on form submit
        submitNewAddress.addEventListener("click", function(event) {
            event.preventDefault();
            newAddressModal.classList.add("hidden");
        });

        // X√°c nh·∫≠n ƒë·ªãa ch·ªâ
        confirmAddressBtn.addEventListener("click", function() {
            // Get the selected address radio button
            const selectedRadio = document.querySelector('input[name="selectedAddress"]:checked');

            if (selectedRadio) {
                const addressId = selectedRadio.value;

                // Find the corresponding address in the addresses array
                const selectedAddress = addresses.find(addr => addr.id == addressId);
                console.log("id", selectedAddress);
                if (selectedAddress) {
                    // Update the displayed address
                    updateDisplayedAddress(selectedAddress);
                    // t√≠nh l·∫°i th·ªùi gian giao h√†ng d·ª± ki·∫øn
                    calculateEstimatedDelivery(selectedAddress.districtId, selectedAddress.wardCode);
                    // Close the modal
                    addressModal.classList.add("hidden");
                }
            }
        });

        // h√†m thay ƒë·ªïi khi ch·ªçn ƒë·ªãa ch·ªâ
        function updateDisplayedAddress(address) {
            // Clear existing address container
            const addressContainer = document.querySelector('.addSelected');

            // Keep the heading and create new content
            const addressDisplay = `
             <div class="ml-2  break-words addSelected">
                    <span class="text-sm font-bold" id="fullName">${address.fullName}</span>
                    <span class="font-bold">(+84)</span>
                    <span class="font-bold" id="phone">${address.phone}</span>
                    <p class="text-sm overflow-hidden break-words" id="addressDetail">
                       ${address.addressDetail}
                    </p>
                    <span id="addressSelect">${address.addressSelected}</span>

                </div>
        `;

            // Set the HTML content of the container
            addressContainer.innerHTML = addressDisplay;

            // Reattach event listener to the new change address button
            const newChangeAddressBtn = document.getElementById("change-address-btn");
            if (newChangeAddressBtn) {
                newChangeAddressBtn.addEventListener("click", function() {
                    addressModal.classList.remove("hidden");
                });
            }
        }
    });

    //L·∫•y danh s√°ch t·ªânh/th√†nh ph·ªë, qu·∫≠n/huy·ªán, ph∆∞·ªùng/x√£ t·ª´ API GHN
    document.addEventListener("DOMContentLoaded", function () {
        const provinceSelect = document.getElementById("province");
        const districtSelect = document.getElementById("district");
        const wardSelect = document.getElementById("ward");

        // G·ªçi API GHN ƒë·ªÉ l·∫•y danh s√°ch t·ªânh/th√†nh ph·ªë
        fetch("https://dev-online-gateway.ghn.vn/shiip/public-api/master-data/province", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                "Token": "ce1b47a4-0206-11f0-b5cc-72ffd7cd7a15" // Thay b·∫±ng API Key th·∫≠t c·ªßa b·∫°n
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    const provinces = data.data.filter(province => province.ProvinceName !== "Test"); // B·ªè t·ªânh "Test"
                    provinceSelect.innerHTML = '<option value="">Ch·ªçn T·ªânh/Th√†nh ph·ªë</option>';
                    provinces.forEach(province => {
                        const option = document.createElement("option");
                        option.value = province.ProvinceID;
                        option.textContent = province.ProvinceName;
                        provinceSelect.appendChild(option);
                    });
                } else {
                    console.error("L·ªói khi l·∫•y danh s√°ch t·ªânh/th√†nh:", data.message);
                }
            })
            .catch(error => console.error("L·ªói k·∫øt n·ªëi API GHN:", error));

        // S·ª± ki·ªán khi ch·ªçn T·ªânh -> G·ªçi API l·∫•y Qu·∫≠n/Huy·ªán
        provinceSelect.addEventListener("change", function () {
            const provinceId = this.value;
            if (!provinceId) return;

            fetch("https://dev-online-gateway.ghn.vn/shiip/public-api/master-data/district", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Token": "ce1b47a4-0206-11f0-b5cc-72ffd7cd7a15"
                },
                body: JSON.stringify({ province_id: parseInt(provinceId) })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        districtSelect.innerHTML = '<option value="">Ch·ªçn Qu·∫≠n/Huy·ªán</option>';
                        wardSelect.innerHTML = '<option value="">Ch·ªçn Ph∆∞·ªùng/X√£</option>'; // Reset Ph∆∞·ªùng/X√£ khi ƒë·ªïi t·ªânh
                        data.data.forEach(district => {
                            const option = document.createElement("option");
                            option.value = district.DistrictID;
                            option.textContent = district.DistrictName;
                            districtSelect.appendChild(option);
                        });
                    } else {
                        console.error("L·ªói khi l·∫•y danh s√°ch qu·∫≠n/huy·ªán:", data.message);
                    }
                })
                .catch(error => console.error("L·ªói k·∫øt n·ªëi API GHN:", error));
        });

        // S·ª± ki·ªán khi ch·ªçn Qu·∫≠n/Huy·ªán -> G·ªçi API l·∫•y Ph∆∞·ªùng/X√£
        districtSelect.addEventListener("change", function () {
            const districtId = this.value;
            if (!districtId) return;

            fetch("https://dev-online-gateway.ghn.vn/shiip/public-api/master-data/ward", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Token": "ce1b47a4-0206-11f0-b5cc-72ffd7cd7a15"
                },
                body: JSON.stringify({ district_id: parseInt(districtId) })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        wardSelect.innerHTML = '<option value="">Ch·ªçn Ph∆∞·ªùng/X√£</option>';
                        data.data.forEach(ward => {
                            const option = document.createElement("option");
                            option.value = ward.WardCode;
                            option.textContent = ward.WardName;
                            wardSelect.appendChild(option);
                        });
                    } else {
                        console.error("L·ªói khi l·∫•y danh s√°ch ph∆∞·ªùng/x√£:", data.message);
                    }
                })
                .catch(error => console.error("L·ªói k·∫øt n·ªëi API GHN:", error));
        });
    });


    document.addEventListener("DOMContentLoaded", function () {

        const addressRadios = document.querySelectorAll('input[name="selectedAddress"]');



        addressRadios.forEach(radio => {
            radio.addEventListener("change", function () {
                const selectedAddress = addresses.find(addr => addr.id == this.value);
                console.log("selectedAddress", selectedAddress);
                if (selectedAddress) {
                    calculateEstimatedDelivery(selectedAddress.districtId, selectedAddress.wardCode);

                }
            });
        });

        const defaultAddress = addresses.find(addr => addr.isDefault);
        if (defaultAddress) {
            calculateEstimatedDelivery(defaultAddress.districtId, defaultAddress.wardCode);
        }



    });

    let  formattedStart = "";
    let formattedEnd ="";
    function calculateEstimatedDelivery(toDistrictId, toWardCode) {
        const estimatedDeliveryElement = document.getElementById("estimated-delivery");
        const totalPricePayment = document.getElementById("total-price-payment");
        if (!toDistrictId || !toWardCode) {
            console.error("L·ªói: toDistrictId ho·∫∑c toWardCode kh√¥ng h·ª£p l·ªá", { toDistrictId, toWardCode });
            estimatedDeliveryElement.innerText = "Ch∆∞a c√≥ ƒë·ªãa ch·ªâ nh·∫≠n h√†ng h·ª£p l·ªá";
            return;
        }

        // ID kho h√†ng m·∫∑c ƒë·ªãnh
        const warehouseDistrictId = 2009;// huyen tam duong
        // console.log("G·ª≠i request v·ªõi:", { toDistrictId, toWardCode, warehouseDistrictId, });

        fetch("https://dev-online-gateway.ghn.vn/shiip/public-api/v2/shipping-order/leadtime", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Token": "ce1b47a4-0206-11f0-b5cc-72ffd7cd7a15",
                "ShopId": "196176"
            },
            body: JSON.stringify({
                from_district_id: warehouseDistrictId,
                from_ward_code: "160210",// x√£ h∆∞·ªõng ƒë·∫°o
                to_district_id: toDistrictId,
                to_ward_code: toWardCode,
                service_id: 53320
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200 && data.data && data.data.leadtime) {
                    const leadtime = new Date(data.data.leadtime * 1000);
                    const endDate = new Date(leadtime);
                    endDate.setDate(endDate.getDate() + 2); // C·ªông th√™m 1 ng√†y

                     formattedStart = leadtime.toLocaleDateString("vi-VN");
                     formattedEnd = endDate.toLocaleDateString("vi-VN");

                    estimatedDeliveryElement.innerText = `${formattedStart} - ${formattedEnd}`;
                    // ====== T√çNH PH√ç SHIP ======
                    const today = new Date();
                    const diffTime = leadtime.getTime() - today.getTime();
                    const daysToDeliver = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); // Chuy·ªÉn t·ª´ mili gi√¢y -> ng√†y

                    let shippingFee;
                    if (daysToDeliver <= 2) {
                        shippingFee = 15000; // Ph√≠ cao
                    } else if (daysToDeliver <= 5) {
                        shippingFee = 30000; // Ph√≠ trung b√¨nh
                    } else {
                        shippingFee = 50000; // Ph√≠ th·∫•p
                    }

                    // Hi·ªÉn th·ªã ph√≠ ship
                    document.getElementById("shipping-fee").innerText = `${shippingFee.toLocaleString()} ƒë`;
                    // T√≠nh t·ªïng ti·ªÅn
                    totalPricePayment.innerText = `${(totalAmount + shippingFee).toLocaleString()} ƒë`;
                } else {
                    estimatedDeliveryElement.innerText = "Kh√¥ng th·ªÉ t√≠nh th·ªùi gian giao h√†ng";
                }
            })

                .catch(error => {
                console.error("L·ªói khi g·ªçi API GHN:", error);
                estimatedDeliveryElement.innerText = "L·ªói k·∫øt n·ªëi GHN";
            });


        fetch("https://dev-online-gateway.ghn.vn/shiip/public-api/master-data/district", {
            method: "GET",
            headers: {
                "Content-Type": "application/json",
                "Token": "ce1b47a4-0206-11f0-b5cc-72ffd7cd7a15" // Thay b·∫±ng Token c·ªßa b·∫°n
            }
        })
            .then(response => response.json())
            .then(data => {
                console.log("Danh s√°ch qu·∫≠n/huy·ªán GHN:", data);

                // T√¨m districtId = 1750 trong danh s√°ch
                const district = data.data.find(d => d.DistrictID === warehouseDistrictId);
                console.log("Qu·∫≠n/Huy·ªán c√≥ district_id = :", district);
            })
            .catch(error => {
                console.error("L·ªói khi l·∫•y danh s√°ch qu·∫≠n/huy·ªán:", error);
            });


    }

    document.getElementById("btn-order-payment").addEventListener("click", async function () {
        const addressElement = document.querySelector('[data-address-id]');
        const addressId = addressElement ? addressElement.getAttribute('data-address-id') : null;
        const paymentMethod = document.querySelector('input[name="payment-method"]:checked'); // Ki·ªÉm tra ph∆∞∆°ng th·ª©c thanh to√°n

        if (!addressId) {
            alertWarning("Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng!"); // C·∫£nh b√°o n·∫øu thi·∫øu ƒë·ªãa ch·ªâ
            return;
        }

        if (!paymentMethod) {
            alertWarning("Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n!"); // C·∫£nh b√°o n·∫øu ch∆∞a ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n
            return;
        }

        // B·∫°n c√≥ th·ªÉ g·ªçi API x·ª≠ l√Ω ƒë∆°n h√†ng ·ªü ƒë√¢y
        const addressDetailEl = document.getElementById("addressDetail").textContent.trim();
        console.log("addressIdEL", addressDetailEl);
        const addressSelectEl = document.getElementById("addressSelect").textContent.trim();
        console.log("addressSelectEl", addressSelectEl);
        const fullNameEl = document.getElementById("fullName").textContent.trim();
        console.log("fullNameEl", fullNameEl);
        const paymentMethodEl = getSelectedPaymentMethod();
        console.log("paymentMethod", paymentMethodEl)
        const phoneEl = document.getElementById("phone").textContent.trim();
        console.log("phoneEl", phoneEl);
        const productCostEl = formatCost(document.getElementById("provisional-costs").textContent.trim());
        console.log("productCostEl", productCostEl);
        const shippingFeeEl =formatCost(document.getElementById("shipping-fee").textContent.trim());
        console.log("shippingFeeEl", shippingFeeEl);
        const totalPricePaymentEl =formatCost(document.getElementById("total-price-payment").textContent.trim());
        console.log("totalPricePaymentEl", totalPricePaymentEl);
        const formattedStartEl = convertToLocalDateTime(`${formattedStart}`)
        console.log("formattedStartEl", formattedStartEl);
        const formattedEndEl = convertToLocalDateTime(`${formattedEnd}`)
        console.log("formattedEndEl", formattedEndEl);

        const data = {
            addressDetail: addressDetailEl,
            addressSelect: addressSelectEl,
            fullName: fullNameEl,
            paymentMethod: paymentMethodEl,
            phone: phoneEl,
            productCost: productCostEl,
            shippingCost: shippingFeeEl,
            total: totalPricePaymentEl,
            deliveryStartDate: formattedStartEl,
            deliveryEndDate: formattedEndEl
        };

        try {
            if (paymentMethodEl === "COD") {
                // N·∫øu l√† COD, t·∫°o ƒë∆°n h√†ng ngay
                const response = await axios.post('/api/create-order', data);
                if (response.status === 200) {
                    alertSuccess("ƒê·∫∑t h√†ng th√†nh c√¥ng!");
                    window.location.href = "/order"; // Chuy·ªÉn h∆∞·ªõng sau khi ƒë·∫∑t h√†ng th√†nh c√¥ng
                } else {
                    alertError("ƒê·∫∑t h√†ng th·∫•t b·∫°i!");
                }
            } else if (paymentMethodEl === "Bank") {
                console.log("Chuy·ªÉn kho·∫£n qua ng√¢n h√†ng");
                const response = await axios.post('/api/create-order', data);
                if (response.status === 200 && response.data.qrCode) {
                    showQRCode(response.data.qrCode, response.data.orderId);
                } else {
                    alert("L·ªói khi t·∫°o ƒë∆°n h√†ng thanh to√°n qua ng√¢n h√†ng!");
                }
                console.log("tong tien",data.total);
            }
        } catch (e) {
            console.log(e);
        }

    });
    // h√†m hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
    // Hi·ªÉn th·ªã QR Code v√† b·∫Øt ƒë·∫ßu ki·ªÉm tra tr·∫°ng th√°i thanh to√°n
    function showQRCode(qrUrl, orderId) {
        const totalPricePaymentEl =document.getElementById("total-price-payment").textContent.trim();
        // C·∫≠p nh·∫≠t th√¥ng tin modal
        document.getElementById("qr-code").src = qrUrl;
        document.getElementById("payment-amount").textContent = `${totalPricePaymentEl}`;
        document.getElementById("payment-content").textContent = orderId;

        // Hi·ªÉn th·ªã modal thanh to√°n
        new bootstrap.Modal(document.getElementById("paymentModal")).show();

        // B·∫Øt ƒë·∫ßu ki·ªÉm tra tr·∫°ng th√°i thanh to√°n
        startPaymentStatusPolling(orderId);
    }


    // Ki·ªÉm tra tr·∫°ng th√°i thanh to√°n m·ªói 3 gi√¢y
    function startPaymentStatusPolling(orderId) {
        const checkStatusUrl = `/api/check-status/${orderId}`;
        const paymentStatusEl = document.getElementById("payment-status");

        console.log("üîπ B·∫Øt ƒë·∫ßu ki·ªÉm tra tr·∫°ng th√°i ƒë∆°n h√†ng:", orderId);

        const polling = setInterval(async () => {
            try {
                const response = await axios.get(checkStatusUrl);
                console.log("üîπ Tr·∫°ng th√°i ƒë∆°n h√†ng nh·∫≠n ƒë∆∞·ª£c:", response.data);

                if (response.status === 200 && response.data.paymentStatus === "PAID") {
                    clearInterval(polling);
                    paymentStatusEl.innerHTML = `<span class="text-success">‚úÖ Thanh to√°n th√†nh c√¥ng!</span>`;

                    // ƒê√≥ng modal sau 3 gi√¢y
                    setTimeout(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById("paymentModal"));
                        modal.hide();
                        // window.location.href = "/order"; // Chuy·ªÉn h∆∞·ªõng v·ªÅ trang ƒë∆°n h√†ng
                    }, 3000);
                }
            } catch (error) {
                console.error("‚ö† L·ªói khi ki·ªÉm tra tr·∫°ng th√°i thanh to√°n:", error);
            }
        }, 3000);
    }

    //h√†m chuy·ªÉn ƒë·ªïi ng√†y th√°ng nƒÉm
    function convertToLocalDateTime(dateString) {
        const [day, month, year] = dateString.split("/").map(Number);
        const formattedDate = new Date(year, month - 1, day, 0, 0, 0);
        return formattedDate.toISOString().slice(0, 19); // yyyy-MM-ddTHH:mm:ss
    }

    //h√†m chuy·ªÉn ƒë·ªïi chu·ªói ti·ªÅn v·ªÅ s·ªë
    function formatCost(value) {
        return parseFloat(value.replace(/[,.‚Ç´ƒë]/g, "")); // B·ªè d·∫•u ph√¢n c√°ch v√† ƒë∆°n v·ªã ti·ªÅn t·ªá
    }

    //h√†m l·∫•y ph∆∞∆°ng th·ª©c thanh to√°n
    function getSelectedPaymentMethod() {
        const selectedRadio = document.querySelector('input[name="payment-method"]:checked');

        if (selectedRadio) {
            const paymentDiv = selectedRadio.closest("div");
            const paymentText = paymentDiv ? paymentDiv.querySelector("span").textContent.trim() : "";

            // B·∫£n ƒë·ªì √°nh x·∫° t·ª´ n·ªôi dung ƒë·∫ßy ƒë·ªß sang m√£ ng·∫Øn g·ªçn
            const paymentMap = {
                "Thanh to√°n khi nh·∫≠n h√†ng": "COD",
                "Chuy·ªÉn kho·∫£n qua ng√¢n h√†ng": "Bank",
                "Th·∫ª ATM/Visa/Master/JCB/QR Pay qua c·ªïng VNPAY": "VNPay",
                "V√≠ Moca tr√™n ·ª©ng d·ª•ng Grab": "Moca",
                "V√≠ Momo": "Momo",
                "V√≠ ShopeePay": "ShopeePay"
            };

            return paymentMap[paymentText] || paymentText; // Tr·∫£ v·ªÅ m√£ ng·∫Øn g·ªçn n·∫øu c√≥, n·∫øu kh√¥ng th√¨ gi·ªØ nguy√™n
        } else {
            console.warn("Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n!");
            return null;
        }
    }


</script>
</body>

</html>